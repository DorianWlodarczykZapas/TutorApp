{% extends "base.html" %}
{% load i18n %}
{% block title %}
    {% trans "Task" %} {{ task.task_id }} | {{ task.exam }}
{% endblock %}
{% block content %}
    <div class="task-preview-page">
        <div class="container mt-4">
            <div class="task-header mb-4">
                <h1>{% trans "Task preview" %}</h1>
                <h2>{% trans "Task" %} {{ task.task_id }}</h2>
                <p class="lead">{% trans "Exam" %}: {{ task.exam }}</p>
                <!-- Status + przycisk toggle -->
                <div class="task-actions mt-3">
                    <span id="task-status"
                          class="status-badge {% if user in task.completed_by.all %}status-completed{% else %}status-not-completed{% endif %}">
                        {% if user in task.completed_by.all %}
                            {% trans "Completed" %}
                        {% else %}
                            {% trans "Not completed" %}
                        {% endif %}
                    </span>
                    <button id="toggle-completed" class="btn-submit" type="button">
                        {% if user in task.completed_by.all %}
                            {% trans "Mark as not completed" %}
                        {% else %}
                            {% trans "Mark as completed" %}
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
        <div class="pdf-viewer-container">
            <div class="pdf-embed-wrapper">
                <embed src="{% url 'examination_tasks:task-pdf-stream' pk=task.pk %}#view=FitH&toolbar=0"
                       type="application/pdf"
                       width="100%"
                       height="100%" />
                <a href="{% url 'examination_tasks:task-pdf-stream' pk=task.pk %}"
                   target="_blank"
                   class="pdf-overlay-link"
                   aria-label="{% trans 'Open PDF in a new tab' %}"></a>
            </div>
        </div>
    </div>
    <script>
document.getElementById("toggle-completed").addEventListener("click", async () => {
    const response = await fetch(window.location.href, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
        }
    });
    const data = await response.json();

    const statusBadge = document.getElementById("task-status");
    const button = document.getElementById("toggle-completed");

    if (data.completed) {
        statusBadge.textContent = "{{ _('Completed') }}";
        statusBadge.classList.remove("status-not-completed");
        statusBadge.classList.add("status-completed");
        button.textContent = "{{ _('Mark as not completed') }}";
    } else {
        statusBadge.textContent = "{{ _('Not completed') }}";
        statusBadge.classList.remove("status-completed");
        statusBadge.classList.add("status-not-completed");
        button.textContent = "{{ _('Mark as completed') }}";
    }
});
    </script>
{% endblock %}
