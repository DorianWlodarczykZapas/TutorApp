{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
    <div class="wizard-container">
        <h1 class="wizard-title">{{ title }}</h1>
        <div class="wizard-progress">
            <div class="progress-step {% if wizard.steps.current == 'basic_data' %}active{% elif wizard.steps.step1 > 0 %}completed{% endif %}">
                <span class="step-number">1</span>
                <span class="step-label">{% trans "Basic Data" %}</span>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step {% if wizard.steps.current == 'preview' %}active{% endif %}">
                <span class="step-number">2</span>
                <span class="step-label">{% trans "Preview & Confirm" %}</span>
            </div>
        </div>
        {% if messages %}
            <ul class="messages-list">
                {% for message in messages %}<li class="alert alert-{{ message.tags }}">{{ message }}</li>{% endfor %}
            </ul>
        {% endif %}
        <form method="post" class="wizard-form">
            {% csrf_token %}
            {{ wizard.management_form }}
            {% if wizard.steps.current == 'basic_data' %}
                <div class="form-step">
                    <h2>{% trans "Step 1: Enter Task Information" %}</h2>
                    {% if wizard.form.non_field_errors %}<div class="form-errors">{{ wizard.form.non_field_errors }}</div>{% endif %}
                    {% for field in wizard.form %}
                        <div class="form-group">
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                                {% if field.field.required %}<span class="required">*</span>{% endif %}
                            </label>
                            {{ field }}
                            {% if field.help_text %}<small class="form-help-text">{{ field.help_text }}</small>{% endif %}
                            {% if field.errors %}<div class="field-errors">{{ field.errors }}</div>{% endif %}
                        </div>
                    {% endfor %}
                    <div class="wizard-buttons">
                        {# Cancel button #}
                        <button type="submit" name="cancel" value="1" class="btn btn-outline-danger">‚úï {% trans "Cancel" %}</button>
                        <div class="button-spacer"></div>
                        {# Next button #}
                        <button type="submit" class="btn btn-primary">{% trans "Next: Preview" %} ‚Üí</button>
                    </div>
                </div>
            {% endif %}
            {% if wizard.steps.current == 'preview' %}
                <div class="form-step">
                    <h2>{% trans "Step 2: Preview Task" %}</h2>
                    {% if pdf_preview_url %}
                        <div class="preview-section">
                            <h3>üìÑ {% trans "Task PDF Preview" %}</h3>
                            <div class="pdf-preview-container">
                                <iframe src="{{ pdf_preview_url }}"
                                        width="100%"
                                        height="600px"
                                        frameborder="0"></iframe>
                            </div>
                            <div class="pdf-download-link">
                                <a href="{{ pdf_preview_url }}"
                                   target="_blank"
                                   class="btn btn-sm btn-outline-primary">üîó {% trans "Open PDF in new tab" %}</a>
                            </div>
                        </div>
                    {% endif %}
                    <div class="preview-section">
                        <h3>üìÅ {% trans "Generated File Information" %}</h3>
                        {% for field in wizard.form %}
                            {% if field.name == 'task_screen' %}
                                <div class="form-group">
                                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.help_text %}<small class="form-help-text">{{ field.help_text }}</small>{% endif %}
                                    {% if task_screen_path %}
                                        <div class="file-info">
                                            <strong>{% trans "File location:" %}</strong>
                                            <br>
                                            <code>{{ task_screen_path }}</code>
                                            <br>
                                            <small class="text-muted">{% trans "This file will be moved to the final location after saving." %}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="preview-section">
                        <h3>üìù {% trans "Extracted Task Content" %}</h3>
                        {% for field in wizard.form %}
                            {% if field.name == 'task_content' %}
                                <div class="form-group">
                                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                    {{ field }}
                                    {% if field.help_text %}<small class="form-help-text">{{ field.help_text }}</small>{% endif %}
                                    <small class="text-muted">
                                        {% trans "Characters:" %} <span id="char-count">{{ field.value|length|default:0 }}</span>
                                    </small>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="preview-section">
                        {% for field in wizard.form %}
                            {% if field.name == 'confirm' %}
                                <div class="form-group form-check">
                                    {{ field }}
                                    <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
                                    {% if field.errors %}<div class="field-errors">{{ field.errors }}</div>{% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% if preview_error %}
                        <div class="alert alert-danger">
                            <strong>{% trans "Preview Error:" %}</strong> {{ preview_error }}
                        </div>
                    {% endif %}
                    <div class="wizard-buttons">
                        <button type="submit" name="cancel" value="1" class="btn btn-outline-danger">‚úï {% trans "Cancel" %}</button>
                        <div class="button-spacer"></div>
                        <button type="submit"
                                class="btn btn-secondary"
                                name="wizard_goto_step"
                                value="basic_data">‚Üê {% trans "Back to Edit" %}</button>
                        <button type="submit" class="btn btn-success">‚úì {% trans "Save Task" %}</button>
                    </div>
                </div>
            {% endif %}
        </form>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
document.addEventListener('DOMContentLoaded', function() {



    const sectionSelect = document.getElementById('id_basic_data-section');
    const topicSelect = document.getElementById('id_basic_data-topic');

    if (sectionSelect && topicSelect) {
        sectionSelect.addEventListener('change', function() {
            const sectionId = this.value;


            topicSelect.innerHTML = '<option value="">---------</option>';

            if (sectionId) {
                fetch(`{% url 'examination_tasks:ajax_topics' %}?section_id=${sectionId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(topic => {
                            const option = new Option(topic.name, topic.id);
                            topicSelect.add(option);
                        });
                    })
                    .catch(error => console.error('Error loading topics:', error));
            }
        });
    }


    const taskContentTextarea = document.getElementById('id_preview-task_content');
    const charCount = document.getElementById('char-count');

    if (taskContentTextarea && charCount) {
        taskContentTextarea.addEventListener('input', function() {
            charCount.textContent = this.value.length;
        });
    }


    const taskScreenInput = document.getElementById('id_preview-task_screen');
    if (taskScreenInput) {
        taskScreenInput.addEventListener('click', function() {
            this.select(); // Select all text for easy copying
        });
    }


    const cancelButtons = document.querySelectorAll('button[name="cancel"]');

    cancelButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            const confirmed = confirm(
                '{% trans "Are you sure you want to cancel? All entered data will be lost." %}'
            );

            if (!confirmed) {
                event.preventDefault();
                return false;
            }
        });
    });
});
    </script>
{% endblock %}
