{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% block title %}
    {% trans "Add Matriculation Task" %}
{% endblock %}
{% block content %}
    <div class="form-container">
        {% if messages %}
            <ul class="messages-list">
                {% for message in messages %}<li class="alert alert-{{ message.tags }}">{{ message }}</li>{% endfor %}
            </ul>
        {% endif %}
        <form method="post" id="add-task-form">
            {% csrf_token %}
            <h1 class="form-title">{% trans "Add New Matriculation Task" %}</h1>
            {% if form.non_field_errors %}<div class="form-errors">{{ form.non_field_errors|striptags }}</div>{% endif %}
            {% for field in form %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}<small class="form-help-text">{{ field.help_text }}</small>{% endif %}
                    {% if field.errors %}<div class="field-errors">{{ field.errors|striptags }}</div>{% endif %}
                </div>
            {% endfor %}
            <div id="task-preview" style="display: none;">
                <h3>{% trans "Task Preview" %}</h3>
                <div id="pdf-preview"></div>
                <div id="text-preview"></div>
            </div>
            <button type="button" id="preview-btn" class="btn-secondary">{% trans "Preview Task" %}</button>
            <button type="submit" class="btn-submit">{% trans "Add Task" %}</button>
        </form>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
document.addEventListener('DOMContentLoaded', function() {

    const sectionSelect = document.getElementById('id_section');
    const topicSelect = document.getElementById('id_topic');

    if (sectionSelect && topicSelect) {
        sectionSelect.addEventListener('change', function() {
            const sectionId = this.value;


            topicSelect.innerHTML = '<option value="">---------</option>';

            if (sectionId) {
                fetch(`{% url 'examination_tasks:ajax_topics' %}?section_id=${sectionId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(topic => {
                            const option = new Option(topic.name, topic.id);
                            topicSelect.add(option);
                        });
                    })
                    .catch(error => console.error('Error loading topics:', error));
            }
        });
    }


    const previewBtn = document.getElementById('preview-btn');
    const examSelect = document.getElementById('id_exam');
    const taskIdInput = document.getElementById('id_task_id');
    const taskPagesInput = document.getElementById('id_task_pages');

    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            const examId = examSelect.value;
            const taskId = taskIdInput.value;
            const pages = taskPagesInput.value;

            if (!examId || !taskId || !pages) {
                alert('{% trans "Please fill in Exam, Task Number and Task Pages" %}');
                return;
            }


            const pageNumber = pages.includes('-') ? pages.split('-')[0] : pages;


            const formData = new FormData();
            formData.append('exam_id', examId);
            formData.append('task_number', taskId);
            formData.append('page', pageNumber);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "examination_tasks:ajax_preview_task" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {

                    const previewDiv = document.getElementById('task-preview');
                    const pdfPreview = document.getElementById('pdf-preview');
                    const textPreview = document.getElementById('text-preview');

                    pdfPreview.innerHTML = `<iframe src="${data.pdf_url}" width="100%" height="500px"></iframe>`;
                    textPreview.innerHTML = `<p>${data.task_text}</p>`;
                    previewDiv.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{% trans "Error loading preview" %}');
            });
        });
    }


    if (examSelect) {
        examSelect.addEventListener('change', function() {

            const form = document.getElementById('add-task-form');
            const formData = new FormData(form);


        });
    }
});
    </script>
{% endblock %}
